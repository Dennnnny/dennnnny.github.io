{"componentChunkName":"component---src-templates-blog-index-tsx","path":"/zh/blog/how-to-use-google-sheet-as-cloud-function","result":{"data":{"locales":{"edges":[{"node":{"ns":"frontpage","data":"{\"content\":\"２０２２這年，這個網站誕生了\\n因為想要有個地方紀錄自己的成長\\n於是開始製作這個部落格\\n這裡主要是紀錄學習筆記\\n以便日後有需要的話可以來回顧\\n裡面會放一些學習筆記與小作品\\n如果內容有什麼錯誤的\\n還望各位不吝指教\\n也歡迎留言分享與討論\\n希望你逛得開心\\n願原力與你同在 🖖 \",\"skip\":\"略過\",\"resume\":\"關於我\"}","language":"zh"}},{"node":{"ns":"tags","data":"{\"filter-tags\":\"用標籤/標題篩選文章\",\"javascript\":\"javascript\",\"note\":\"筆記\",\"gatsby\":\"gatsby\",\"typescript\":\"typescript\",\"series\":\"系列\",\"style\":\"樣式\",\"gsap\":\"gsap\",\"animation\":\"動畫\",\"google-sheet\":\"Google試算表\",\"cloud-function\":\"Cloud Function\",\"slack\":\"slack\"}","language":"zh"}},{"node":{"ns":"index","data":"{\"about\":\"關於我\",\"change-log\":\"開發日誌\",\"comments\":\"評論\",\"home\":\"家\",\"blog\":\"文章\",\"project\":\"作品\",\"contact\":\"聯絡我\",\"contact-form-title\":\"歡迎留下任何你想說的話 🙏\",\"contact-form-name\":\"你的名稱\",\"contact-form-messages\":\"想說的話\",\"submit\":\"送出\",\"close\":\"關閉\",\"contact-form-success\":\"🎉 已成功送出 🎉\",\"contact-form-errors\":\"抱歉😿\\n好像有什麼出錯了\",\"found-nothing\":\"沒有找到文章...\",\"themeTitle\":\"主題模式\",\"dark\":\"深色\",\"light\":\"淺色\",\"languageTitle\":\"選擇語言\",\"zh\":\"中文\",\"en\":\"英文\",\"workInProgress\":\"努力產出中...\",\"image-source\":\"圖片來源 \",\"what\":\".dsadas..\"}","language":"zh"}}]},"blog":{"frontmatter":{"title":"我把Google Sheet當成Cloud Function用","date":"2022-12-12T04:43:23.629Z","image_cover":"https://images.unsplash.com/photo-1600783245777-080fd7ff9253?fit=crop&w=1000&q=80","img_source":null},"html":"<h2>來使用 google 試算表執行程式</h2>\n<p>今天來分享一下 最近做了一個提醒的通知機器人\n機器人的部分其實只是串接了 slack 的 webhooks\n在以前我通常做這種排程通知 大多都選擇使用 google 的 cloud function\n不過因為免費試用有期限 後續繼續使用的話需要收費\n所以我這邊改用 google 的 spread sheet 來做這件事情</p>\n<p>使用者故事是這樣來子的\n身為公司的福利委員\n每個月都有兩天要拜拜 🙏\n是個很虔誠的公司呢！\n但常常會忘記當天要拜拜這件事情（因為用農曆計算日期）\n但身為一個工程師 怎麼可以花腦袋記這些事情呢 😧\n所以就來製作一個通知機器人吧～\n計畫是按照現行拜拜的日子 來設一個 slack 通知提醒</p>\n<p>需要使用到的工具有三個，接著就來一一說明</p>\n<ol>\n<li>農曆計算日期</li>\n<li>在 <strong>google spread sheet</strong> 上面放程式碼 &#x26; 設定排程</li>\n<li>呼叫 <strong>slack webhook</strong></li>\n</ol>\n<div class=\"separate_line\" >...</div>\n<h2>計算農曆日期</h2>\n<p>這個部分使用 <code>Intl.DateTimeFormat(區域).format(日期)</code>\n要計算農曆的話就是：</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lunarDay</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">Intl</span><span class=\"mtk1\">.</span><span class=\"mtk11\">DateTimeFormat</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;zh-TW-u-ca-chinese&quot;</span><span class=\"mtk1\">).</span><span class=\"mtk11\">format</span><span class=\"mtk1\">(</span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Date</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;2022/12/12&quot;</span><span class=\"mtk1\">)); </span><span class=\"mtk3\">// &#39;2022年冬月19&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">//這裡我只需要&quot;月&quot;後面的文字</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [, </span><span class=\"mtk12\">todayOfLunarCalendar</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">lunarDay</span><span class=\"mtk1\">.</span><span class=\"mtk11\">split</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;月&quot;</span><span class=\"mtk1\">); </span><span class=\"mtk3\">// 19</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 做簡單的判斷， 如果今天是 1 或者 15 就是要拜拜的日子</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\">(</span><span class=\"mtk12\">todayOfLunarCalendar</span><span class=\"mtk1\"> === </span><span class=\"mtk8\">&quot;1&quot;</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">todayOfLunarCalendar</span><span class=\"mtk1\"> === </span><span class=\"mtk8\">&#39;15&#39;</span><span class=\"mtk1\">){</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 要拜拜， 傳送訊號到slack api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span></code></pre>\n<p>參考來自<a href=\"https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Intl/DateTimeFormat\">MDN</a></p>\n<h2>使用 Google Sheet 放程式碼與排程</h2>\n<p>首先，你要先開啟一個新的試算表\n上方工具列裡 點擊擴充功能 -> App script\n這 script 裡就是放程式碼的地方</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"js\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 大致上與普通寫程式差不多 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">reminder</span><span class=\"mtk1\"> () {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk3\">// 檢查今天是不是需要拜拜的日子 </span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">todayOfLunarCalendar</span><span class=\"mtk1\"> === </span><span class=\"mtk8\">&quot;1&quot;</span><span class=\"mtk1\"> || </span><span class=\"mtk12\">todayOfLunarCalendar</span><span class=\"mtk1\"> === </span><span class=\"mtk8\">&quot;15&quot;</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk3\">// 呼叫 slack api, url 等等會換成 slack 的 api</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">UrlFetchApp</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fetch</span><span class=\"mtk1\">(</span><span class=\"mtk8\">&quot;url&quot;</span><span class=\"mtk1\">, {...</span><span class=\"mtk12\">config</span><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ContentService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">createTextOutput</span><span class=\"mtk1\">(</span><span class=\"mtk10\">JSON</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stringify</span><span class=\"mtk1\">({</span><span class=\"mtk12\">status:</span><span class=\"mtk7\">200</span><span class=\"mtk1\">, </span><span class=\"mtk12\">msg:</span><span class=\"mtk8\">&quot;success&quot;</span><span class=\"mtk1\">}))</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 註一： 在 App Script 裡，要使用 fetch 的話，要用這個 =&gt;  UrlFetchApp.fetch</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 註二： 要回傳 Response 時，要使用 ContentService.createTextOutput(JSON.stringify(result))</span></span></span></code></pre>\n<p>有興趣的話，可以在<a href=\"https://developers.google.com/apps-script/overview\">官方文件</a>裡找一些參考</p>\n<h2>使用 Slack api 傳送訊息</h2>\n<p>這裡我使用的是 Slack 的 webhook\n先傳送<a href=\"https://api.slack.com/messaging/webhooks\">官方文件</a>\n首先要先在右上角建立一個你的 Apps\n接著點進你的 Apps 裡面後，\n選擇『 Add features and functionality 』 點選新增一個 Webhook 到工作區\n你會得到一個 URL 大致上長這樣： <code>https://hooks.slack.com/services/T1CXXXXXX/B04DXXXXXXX/gkXXXXXXXXXXXXXXX</code>\n你可以直接用 Postman 測試這個 URL\n使用參數</p>\n<pre class=\"grvsc-container dark-default-dark\" data-language=\"\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\">  method: POST </span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  Header: Content-type: application/json</span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\">  body:   {&quot;text&quot;:&quot;Hello, World!&quot;}</span></span></code></pre>\n<h2>Google Sheet 設定排程</h2>\n<p>設定完之後\n回到剛剛的 Google Sheet 裡把 slack api 補進去 UrlFetchApp.fetch\n（可以在程式碼上方欄位找到執行，按下去則可以針對選擇的函式做測試喔！）\n確認無誤後，可以選擇左方 sidebar 的鬧鐘圖示（觸發條件）\n點選藍色按鈕 新增觸發條件+\n然後調整觸發條件為你需要的觸發時機\n例如 這次我需要每週都執行一次\n可以選擇 活動來源：時間驅動 => 週計時器 => 每週一 => 上午9點 => 儲存\n這樣一來 程式就會自動在每週一上午九點執行一次\n如果有錯誤也會通知你\n如果是第一次使用這個功能\nApp Script 會要求你開通授權，按確認之後一切就準備就緒了！</p>\n<div class=\"separate_line\" >...</div>\n<p>這次做了計算農曆日期、把 Google 表單當作 Cloud Function 使用\n我覺得很方便\n目前也沒有要收費，應該可以安心使用\n如果有什麼疑問或是沒有說清楚的地方，都可以留言跟我說</p>\n<p>以上是今天的分享 👋</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .dark-default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .dark-default-dark .mtk1 { color: #D4D4D4; }\n  .dark-default-dark .mtk4 { color: #569CD6; }\n  .dark-default-dark .mtk12 { color: #9CDCFE; }\n  .dark-default-dark .mtk10 { color: #4EC9B0; }\n  .dark-default-dark .mtk11 { color: #DCDCAA; }\n  .dark-default-dark .mtk8 { color: #CE9178; }\n  .dark-default-dark .mtk3 { color: #6A9955; }\n  .dark-default-dark .mtk15 { color: #C586C0; }\n  .dark-default-dark .mtk7 { color: #B5CEA8; }\n  .dark-default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>"}},"pageContext":{"language":"zh","name":"how-to-use-google-sheet-as-cloud-function","i18n":{"language":"zh","languages":["en","zh"],"defaultLanguage":"en","generateDefaultLanguagePage":false,"routed":true,"originalPath":"/blog/how-to-use-google-sheet-as-cloud-function","path":"zh/blog/how-to-use-google-sheet-as-cloud-function"}}},"staticQueryHashes":["3764592887"]}